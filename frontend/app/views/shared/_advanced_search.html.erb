<%
  values_for_operator = jsonmodel_definition(:boolean_query).options_for(:unused, "op", false, :i18n_prefix => "advanced_search.operator")
  values_for_scope = jsonmodel_definition(:staff_field_query).options_for(:unused, "field")
  values_for_boolean_scope = jsonmodel_definition(:boolean_field_query).options_for(:unused, "field")
  values_for_date_scope = jsonmodel_definition(:date_field_query).options_for(:unused, "field")
  values_for_date_comparators = jsonmodel_definition(:date_field_query).options_for(:unused, "comparator", false, :i18n_prefix => "advanced_search.date_operator")
%>

<div id="template_advanced_search_row"><!--
  <div class="row-fluid">
    <div class="span2">
      <%= hidden_field_tag "t${field_data.index}", "${field_data.type}" %>
      ${AS.renderTemplate("template_advanced_search_op_select", field_data)}
    </div>
    ${AS.renderTemplate("template_advanced_search_"+field_data.type+"_fields", field_data)}
    <div class="span1">
      <a href="#" class="btn btn-danger advanced-search-remove-row"><span class="icon icon-trash icon-white"></span></a>
    </div>
  </div>
--></div>

<div id="template_advanced_search_op_select"><!--
  {if first}
  <select name="op${index}" id="op${index}" class="advanced-search-row-op-input">
    <option></option>
    <% values_for_operator.select{|op| op[1] == "NOT"}.each do |op| %><option value="<%= op[1] %>" {if query.op == "<%= op[1] %>" || (query.negated && "NOT" == "<%= op[1] %>")}selected{/if}><%= op[0] %></option><% end %>
  </select>
  {else}
  <select name="op${index}" id="op${index}" class="advanced-search-row-op-input">
    <% values_for_operator.each do |op| %><option value="<%= op[1] %>" {if query.op == "<%= op[1] %>" || (query.negated && "NOT" == "<%= op[1] %>")}selected{/if}><%= op[0] %></option><% end %>
  </select>
  {/if}
--></div>


<div id="template_advanced_search_text_fields"><!--
  <div class="span3">
    <select name="f${index}" id="f${index}" <% if values_for_scope.length > AspaceFormHelper::COMBOBOX_MIN_LIMIT %> data-combobox="true"<% end %>>
      <% values_for_scope.each do |op| %>
        <option value="<%= op[1] %>" {if query.field == "<%= op[1] %>" || (query.field == null && "<%= JSONModel.enum_default_value("staff_field_query_field") %>" == "<%= op[1] %>")}selected{/if}><%= op[0] %></option>
      <% end %>
    </select>
  </div>
  <div class="span6">
    <%= text_field_tag "v${index}", "${query.value}", :id => "v${index}" %>
  </div>
--></div>

<div id="template_advanced_search_date_fields"><!--
  <div class="span3">
    <select name="f${index}" id="f${index}" <% if values_for_date_scope.length > AspaceFormHelper::COMBOBOX_MIN_LIMIT %> data-combobox="true"<% end %>>
      <% values_for_date_scope.each do |op| %>
        <option value="<%= op[1] %>" {if query.field == "<%= op[1] %>" || (query.field == null && "<%= JSONModel.enum_default_value("staff_field_query_field") %>" == "<%= op[1] %>")}selected{/if}><%= op[0] %></option>
      <% end %>
    </select>
  </div>
  <div class="span6 advanced-search-date-fields">
    <div class="span4">
      <select name="dop${index}" id="dop${index}">
        <% values_for_date_comparators.each do |op| %>
          <option value="<%= op[1] %>" {if query.comparator == "<%= op[1] %>" || (query.comparator == null && "<%= JSONModel.enum_default_value("staff_field_query_field") %>" == "<%= op[1] %>")}selected{/if}><%= op[0] %></option>
        <% end %>
      </select>
    </div>
    <div class="span8">
      <div class="control-group">
        <%= text_field_tag "v${index}", "${query.value}", :id => "v${index}", :class => "date-field", :"data-format" => "yyyy-mm-dd", :"data-date" => Date.today.strftime('%Y-%m-%d') %>
      </div>
    </div>
  </div>
--></div>

<div id="template_advanced_search_bool_fields"><!--
  <div class="span3">
    <select name="f${index}" id="f${index}" <% if values_for_boolean_scope.length > AspaceFormHelper::COMBOBOX_MIN_LIMIT %> data-combobox="true"<% end %>>
      <% values_for_boolean_scope.each do |op| %>
        <option value="<%= op[1] %>" {if query.field == "<%= op[1] %>" || (query.field == null && "<%= JSONModel.enum_default_value("staff_field_query_field") %>" == "<%= op[1] %>")}selected{/if}><%= op[0] %></option>
      <% end %>
    </select>
  </div>
  <div class="span6 advanced-search-boolean-field">
    <select name="v${index}" id="v${index}">
      <option value="true" {if query.value}selected{/if}><%= I18n.t("advanced_search.boolean_field.true_value") %></option>
      <option value="false" {if !query.value}selected{/if}><%= I18n.t("advanced_search.boolean_field.false_value") %></option>
    </select>
  </div>
--></div>


<%= form_tag(url_for(:controller => :search, :action => :advanced_search), :method => :get, :class => "advanced-search") do %>
  <%= hidden_field_tag "advanced", true %>

  <div class="advanced-search-row-container" data-queries='<%= advanced_search_queries.to_json %>'></div>

  <div class="row-fluid">
    <div class="span11">
      <hr />
    </div>
    <div class="span1">
      <div class="btn-group">
        <a class="btn btn-success dropdown-toggle advanced-search-add-row-dropdown" data-toggle="dropdown" href="#">
          <span class="icon icon-plus icon-white"></span>
          <span class="caret"></span>
        </a>
        <ul class="dropdown-menu pull-right">
          <li><%= link_to "Text", "javascript:void(0)", :class => "advanced-search-add-row advanced-search-add-text-row", "data-type" => "text" %></li>
          <li><%= link_to "Date", "javascript:void(0)", :class => "advanced-search-add-row advanced-search-add-date-row", "data-type" => "date" %></li>
          <li><%= link_to "Boolean", "javascript:void(0)", :class => "advanced-search-add-row advanced-search-add-bool-row", "data-type" => "bool" %></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="row-fluid">
    <div class="span6">
      <%= link_to I18n.t("advanced_search.index_switcher.hide"), { :advanced => nil }, {:class => "search-switcher-hide"} %>
    </div>
      <% if current_page?(root_url) %>
        <div class="span2"></div>
        <div class="span3">
          <button class="btn btn-primary"><%= I18n.t("advanced_search.button_text") %></button>
        </div>
        <div class="span1"></div>
      <% else %>
        <div class="span2">
          <%= link_to I18n.t("advanced_search.reset"), {:controller => :search, :action => :do_search, :advanced => true}, :class => "btn reset-advanced-search pull-right" %>
        </div>
        <div class="span3">
          <button class="btn btn-primary"><%= I18n.t("advanced_search.button_text") %></button>
        </div>
        <div class="span1"></div>
      <% end %>
    </div>
  </div>
  <div class="clearfix"></div>
<% end %>